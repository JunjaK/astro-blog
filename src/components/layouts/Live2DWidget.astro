<script is:inline>
(function () {
  if (screen.width < 768) return;
  if (document.getElementById('waifu')) return;

  var CDN = 'https://fastly.jsdelivr.net/npm/live2d-widgets@1.0.0/dist/';

  function loadCSS(url) {
    if (document.querySelector('link[href="' + url + '"]')) return Promise.resolve();
    return new Promise(function (resolve, reject) {
      var link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = url;
      link.onload = resolve;
      link.onerror = reject;
      document.head.appendChild(link);
    });
  }

  function loadModule(url) {
    if (document.querySelector('script[src="' + url + '"]')) return Promise.resolve();
    return new Promise(function (resolve, reject) {
      var script = document.createElement('script');
      script.type = 'module';
      script.src = url;
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  Promise.all([
    loadCSS(CDN + 'waifu.css'),
    loadModule(CDN + 'waifu-tips.js'),
  ]).then(function () {
    initWidget({
      waifuPath: '/live2d/waifu-tips.json',
      cdnPath: '/live2d/',
      cubism5Path: 'https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js',
      tools: ['photo', 'info', 'quit'],
      logLevel: 'warn',
      drag: false,
    });
  });

  // SPA persistence: move Live2D DOM nodes to new document on page swap
  document.addEventListener('astro:before-swap', function (e) {
    var waifu = document.getElementById('waifu');
    var toggle = document.getElementById('waifu-toggle');
    if (waifu) e.newDocument.body.appendChild(waifu);
    if (toggle) e.newDocument.body.appendChild(toggle);
  });
})();
</script>
